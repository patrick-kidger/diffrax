from collections.abc import Callable
from typing import ClassVar

import numpy as np

from diffrax._local_interpolation import RodasInterpolation

from .rosenbrock import AbstractRosenbrock, RosenbrockTableau


_tableau = RosenbrockTableau(
    a_lower=(
        np.array([0.4449064090300329]),
        np.array([0.07677903180167778, 0.4624140286611761]),
        np.array([0.2715966298505797, 0.024261038578611376, 0.0962162873625294]),
        np.array(
            [
                0.13056870819244193,
                0.10608921854908092,
                0.07184009387521109,
                0.23088710342969945,
            ]
        ),
        np.array(
            [
                0.08897171823756839,
                0.09218114987776381,
                0.05583033499983675,
                0.10649965215453717,
                0.40617873937690313,
            ]
        ),
        np.array(
            [
                0.11019741516029526,
                -0.16388371104442587,
                -0.0032969640636369723,
                0.3163630533498828,
                -0.1566367911100605,
                -0.011032473495837887,
            ]
        ),
        np.array(
            [
                0.1743288347622427,
                0.09148806279642346,
                0.12526454856619265,
                0.032117827315093175,
                -0.03757732276408586,
                0.09178235225043695,
                0.23935769888017283,
            ]
        ),
        np.array(
            [
                0.18060331852757813,
                0.2218793874497133,
                0.03168556623998156,
                -0.15719656408812635,
                0.1996673917771067,
                0.2522778259405284,
                0.09487166449206226,
                0.09637988336485837,
            ]
        ),
        np.array(
            [
                0.023492989441061887,
                0.11594006266139455,
                0.011294566957257769,
                0.047647666927047,
                0.009892220443226867,
                0.05293337076376641,
                0.029304424981613626,
                0.27857516233845897,
                0.13266909660400167,
            ]
        ),
        np.array(
            [
                0.11615781805485326,
                0.012671047453286838,
                0.12312422241657578,
                0.033961169909360954,
                -0.056004118198544096,
                0.09965544894527922,
                0.19878184273513894,
                0.06186889219835338,
                0.08284034358233273,
                -0.11434144918279239,
            ]
        ),
        np.array(
            [
                0.13598610642419412,
                0.10363218827919163,
                -0.07148149996983422,
                0.0288477382465383,
                -0.20323956481807517,
                -0.001713730445912451,
                -0.19471655896908882,
                0.2031517131715248,
                -0.08951019562920948,
                0.12043115551061613,
                0.07757452726451514,
            ]
        ),
        np.array(
            [
                -0.09841917421605546,
                -0.026478450703488553,
                0.18007359200035913,
                0.02196676131482085,
                0.21124155571562414,
                -0.050527478715912344,
                -0.02084467897497797,
                0.16897325857941667,
                -0.13712123172185975,
                0.06110580452136368,
                0.030811444882892926,
                0.16660134935977738,
            ]
        ),
        np.array(
            [
                0.33135135124360793,
                0.03118734777674928,
                -0.07879324862226805,
                0.2245446126022312,
                0.022469194650936643,
                0.37239595062239006,
                0.0009098913202429551,
                0.012385624079514965,
                0.19604027558517262,
                -0.08476793445376751,
                -0.1578249148143089,
                -0.005371982240487397,
                0.13547383224998621,
            ]
        ),
        np.array(
            [
                0.09688909923555757,
                0.03599936730650917,
                0.15009692972285202,
                0.023028640912040498,
                0.0551174062439816,
                0.003920718433337755,
                0.15921042162127447,
                0.10589252109534522,
                -0.10542965045367435,
                0.10408358812094748,
                0.11840650606851148,
                0.21193053740570028,
                -0.2191460857123832,
                0.26,
            ]
        ),
        np.array(
            [
                -0.08865887976349773,
                -0.1407329910679121,
                0.0380655571595128,
                0.11543290790588803,
                0.5774357270423417,
                0.08620987486525787,
                0.2717329267225196,
                0.051872031475884636,
                0.10947253967224155,
                -0.057742405678716406,
                0.11685593479402953,
                0.1260230602628925,
                -0.2568588836203559,
                -0.20910739977008597,
                0.26,
            ]
        ),
        np.array(
            [
                -0.42177792001385633,
                -0.0498513421089399,
                0.14746438866595032,
                0.005203017323461079,
                0.1199333496856976,
                -0.37172946060109385,
                -0.9433778270390042,
                1.3492054904336521,
                0.5053011064251354,
                -0.42105404141248576,
                1.0274115729992814,
                -2.1085515823208523,
                0.6809087523226759,
                0.8635779409111259,
                0.4096360400987381,
                -0.5922994853694857,
            ]
        ),
        np.array(
            [
                0.5213949506491131,
                0.17724475771999976,
                0.15245305944440446,
                0.5105432658191871,
                0.05194489505888186,
                -0.3616272437750905,
                0.5341400582949192,
                -0.2530053332530179,
                -0.08057214956777574,
                0.6618951153851548,
                -0.2492372662728071,
                -0.4892157283437568,
                -0.06837978217149134,
                -0.18070136156522695,
                0.00941166895538048,
                -0.46308947781601606,
                0.026800571438141404,
            ]
        ),
        np.array(
            [
                0.0966385515734799,
                0.07946370299991386,
                0.05694508557458896,
                0.08341839775677805,
                0.05039055884672026,
                -0.040498903677192874,
                0.05997628312788093,
                -0.04169477919021534,
                0.17344604237191416,
                0.16768945886789643,
                0.023894807429810788,
                0.1360629558390068,
                -0.052886921593227915,
                -0.031023612012273227,
                0.04443654008682913,
                0.02500751197654184,
                -0.01725400677734344,
                -0.014011673201108226,
            ]
        ),
    ),
    c_lower=(
        np.array([-0.4449064090300329]),
        np.array([-0.2249304011820195, -0.5796012841055479]),
        np.array([-0.191363890541243, -0.009954583997469643, -0.09098450342777242]),
        np.array(
            [
                0.12124476943541979,
                -0.6351093302459851,
                0.1404882592054098,
                0.05351797762728713,
            ]
        ),
        np.array(
            [
                0.23031556130228487,
                0.028387345541207573,
                0.07247420049725053,
                0.35510428922823084,
                -0.8633556653193706,
            ]
        ),
        np.array(
            [
                -0.20021190146402157,
                1.6043015525766366,
                -0.2659753909573279,
                -0.5559778783026086,
                -0.2957515867484828,
                -0.13052468372615786,
            ]
        ),
        np.array(
            [
                -0.7440750007009634,
                -0.6916138569553807,
                -0.0614465876900378,
                0.553236602108607,
                0.22712938583631936,
                0.022426977173639187,
                -0.05442112338429225,
            ]
        ),
        np.array(
            [
                -0.34036008152584785,
                -0.2736279627599264,
                -0.10160177565829905,
                0.23438137138171278,
                -0.08737303697749066,
                -0.06414235241888491,
                0.060991968367440044,
                -0.21882330355258373,
            ]
        ),
        np.array(
            [
                0.8947941046488969,
                0.1589477123557148,
                0.11305482722556158,
                -0.3329683475206955,
                0.1897443073394501,
                0.009034889182556322,
                -0.31046348685805025,
                -0.5190587421710887,
                -0.3414184269750512,
            ]
        ),
        np.array(
            [
                -1.361447314522775,
                -0.5652833676125102,
                -0.15343197534406774,
                1.2222002893782742,
                -0.10981596297319235,
                -0.020652590577860314,
                0.28487136333230606,
                0.2516255794685591,
                -0.1362625590116298,
                0.17920074456051358,
            ]
        ),
        np.array(
            [
                -0.5764726244588356,
                0.20527748237543764,
                0.22491390055657778,
                0.377455186961336,
                -0.4358032390418337,
                0.011706420226841338,
                0.09307107421233107,
                -0.018049591235410667,
                -0.07281105888178227,
                0.010330043693397475,
                0.13033366754284,
            ]
        ),
        np.array(
            [
                -0.7371771092556694,
                0.21874949362600915,
                -0.16705144727266955,
                0.21250953526894045,
                -0.37003052923927354,
                -0.020080186870843342,
                0.16567052453017536,
                0.16323930092307845,
                -0.0006348703339716377,
                0.15851096857699137,
                0.1253847902213121,
                -0.07196872993374748,
            ]
        ),
        np.array(
            [
                -0.23446225200805038,
                0.0048120195297598894,
                0.22889017834512007,
                -0.2015159716901907,
                0.03264821159304496,
                -0.3684752321890523,
                0.1583005303010315,
                0.09350689701583026,
                -0.301469926038847,
                0.188851522574715,
                0.2762314208828204,
                0.2173025196461877,
                -0.3546199179623694,
            ]
        ),
        np.array(
            [
                -0.18554797899905529,
                -0.17673235837442125,
                -0.11203137256333923,
                0.09240426699384753,
                0.52231832079836,
                0.08228915643192011,
                0.11252250510124512,
                -0.054020489619460585,
                0.21490219012591588,
                -0.1618259937996639,
                -0.0015505712744819516,
                -0.08590747714280778,
                -0.03771279790797272,
                -0.469107399770086,
            ]
        ),
        np.array(
            [
                0.1650900157388432,
                0.06026378280087996,
                -0.0289156122732757,
                0.6917917590878977,
                -0.9357653194500641,
                0.21935867698595923,
                -0.32468571993669837,
                0.3490637671586518,
                -0.3150779234276089,
                0.11287658161847455,
                -0.22037939209027546,
                0.00265086480974272,
                0.10944242676891244,
                0.31870193132074115,
                -0.4644158391121802,
            ]
        ),
        np.array(
            [
                7.070239557182354,
                3.823949272099861,
                -2.4739947909846527,
                -9.106830719336529,
                4.26480760452626,
                4.644845430908578,
                1.8344506678009855,
                1.9931714262283775,
                -0.8510149699158444,
                0.8387084788299215,
                0.3130514423060622,
                1.9722106413621885,
                -2.0281854735700895,
                -2.136402907649397,
                -2.1577500374085044,
                0.25889955137710696,
            ]
        ),
        np.array(
            [
                -0.8324373352379201,
                2.0030630458905074,
                0.6575031069217653,
                -14.46474362807184,
                -0.6176485085087318,
                0.9592916101579977,
                2.0151206548869744,
                6.314335324637572,
                -0.14909056577144825,
                -0.6985248734019209,
                0.029006728665335796,
                -0.13039460770854983,
                -1.1803601303638547,
                -1.0070500677865764,
                -0.6720185642582192,
                0.08395626061575528,
                0.08141151762053207,
            ]
        ),
        np.array(
            [
                13.064418698946389,
                -3.011098407402385,
                -1.8121479173863888,
                -14.958332304435624,
                -3.019120150763236,
                3.4606503589755957,
                4.407059782945183,
                8.708591595447494,
                0.1915708187640984,
                0.379857983789867,
                -0.5250913920725622,
                -2.346613162450365,
                -0.4899822499343198,
                -1.5450070130273,
                -0.77636148553238,
                -1.0664524181625135,
                0.24899128315062613,
                0.3883861132384288,
            ]
        ),
    ),
    α=np.array(
        [
            0.0,
            0.4449064090300329,
            0.5391930604628539,
            0.3920739557917205,
            0.5393851240464334,
            0.7496615946466092,
            0.0917105287962168,
            0.716762001806476,
            0.9201684737037024,
            0.7017495611178288,
            0.5587152179138445,
            0.10896187906445999,
            0.5073827520419607,
            1.0,
            0.9999999999999998,
            1.0,
            0.19999999999999984,
            0.4999999999999998,
            0.8000000000000002,
        ]
    ),
    γ=np.array(
        [
            0.26,
            -0.18490640903003291,
            -0.5445316852875675,
            -0.03230297796648507,
            -0.0598583239778685,
            0.08292573124960323,
            0.4158601113780379,
            -0.4887636036121086,
            -0.5305551731438798,
            0.12166683722729377,
            -0.1489957933023821,
            0.20995126195089905,
            -0.06287825975966782,
            -5.551115123125783e-17,
            5.551115123125783e-17,
            0.0,
            8.520155173756681,
            -7.348580031712621,
            1.559320134090607,
        ]
    ),
    m_sol=np.array(
        [
            13.16105725051987,
            -2.9316347044024713,
            -1.7552028318117998,
            -14.874913906678845,
            -2.968729591916516,
            3.4201514552984027,
            4.467036066073064,
            8.666896816257278,
            0.36501686113601256,
            0.5475474426577635,
            -0.5011965846427514,
            -2.2105502066113583,
            -0.5428691715275478,
            -1.5760306250395733,
            -0.7319249454455509,
            -1.0414449061859716,
            0.2317372763732827,
            0.37437444003732057,
            0.26,
        ]
    ),
    m_error=np.array(
        [
            -0.31104238458880695,
            2.180307803610507,
            0.8099561663661697,
            -13.954200362252653,
            -0.5657036134498499,
            0.5976643663829072,
            2.549260713181894,
            6.061329991384554,
            -0.22966271533922397,
            -0.03662975801676617,
            -0.2202305376074713,
            -0.6196103360523066,
            -1.248739912535346,
            -1.1877514293518032,
            -0.6626068953028387,
            -0.3791332172002608,
            0.10821208905867348,
            0.26,
            0,
        ]
    ),
)


class _Rodas6pInterpolation(RodasInterpolation):
    coeff: ClassVar[np.ndarray] = np.array(
        [
            [
                13.16105725051987,
                -2.9316347044024713,
                -1.7552028318117998,
                -14.874913906678845,
                -2.968729591916516,
                3.4201514552984027,
                4.467036066073064,
                8.666896816257278,
                0.36501686113601256,
                0.5475474426577635,
                -0.5011965846427514,
                -2.2105502066113583,
                -0.5428691715275478,
                -1.5760306250395733,
                -0.7319249454455509,
                -1.0414449061859716,
                0.2317372763732827,
                0.37437444003732057,
                0.26,
            ],
            [
                -0.7536161644473162,
                -0.01780621814729703,
                0.3112612237418469,
                1.0611064515340394,
                -1.0652359845376103,
                0.6059642310938258,
                -0.3226718147514387,
                0.620866811714374,
                -0.6044951046566404,
                0.010274773310579197,
                -0.30978632847317117,
                0.159369489229014,
                -0.0657807246472142,
                0.3034071014088224,
                -0.30036273309599587,
                0.33383241572171013,
                0.016991503926457863,
                -0.017049192207230317,
                0.033730263283244494,
            ],
            [
                -1.3652314832646772,
                -0.20648652712697815,
                -0.7394251030720768,
                -1.4149785517093565,
                3.250938438097276,
                -0.26211300137058213,
                1.4949014024597451,
                -0.7287431904996644,
                0.5337138360828783,
                0.07251745431691457,
                0.5293245302341825,
                -0.41037749793880995,
                -0.41832276214606273,
                -0.36485006045532986,
                0.19207680490489898,
                0.13218751103605175,
                -0.09001301437697083,
                -0.013273172827498137,
                -0.1918456123439404,
            ],
            [
                4.0083130941344605,
                -0.7403072587580443,
                -0.957585556657745,
                -6.581469807660111,
                0.5181550285505504,
                -0.3038168365960891,
                0.2432016630754812,
                2.2695494618785355,
                1.1688818459199255,
                0.13753617125058065,
                0.20493244330091942,
                0.35022907737142644,
                0.2326151775948058,
                -1.158365766772891,
                0.23706716023356755,
                -0.18325959164197905,
                0.1596493666146995,
                0.13139502396413197,
                0.2632793041977739,
            ],
            [
                -3.5185564054506213,
                0.3504609301437913,
                -0.018398098915716414,
                3.9742312225984486,
                2.8009149175008856,
                -2.2324824828301355,
                0.42296653352584535,
                -3.586605515529091,
                1.2729374108308276,
                -0.5004450474718347,
                0.1958566403961525,
                0.12110094063804967,
                0.2595732876041254,
                -0.21546436233277802,
                0.7886704163332257,
                0.14725853126507088,
                -0.09939903361190844,
                -0.07866364284130528,
                -0.08395624185303117,
            ],
        ],
        dtype=np.float64,
    )


class Rodas6p(AbstractRosenbrock):
    r"""Rodas6p method.

    6th order Rosenbrock method for solving stiff equations.

    ??? cite "Reference"

        @article{Steinebach2023,
          author  = {Steinebach, Gerd},
          title   = {Construction of Rosenbrock--Wanner method Rodas5P and numerical
           benchmarks within the Julia Differential Equations package},
          journal = {BIT Numerical Mathematics},
          year    = {2023},
          volume  = {63},
          number  = {2},
          pages   = {27},
          doi     = {10.1007/s10543-023-00967-x},
          url     = {https://doi.org/10.1007/s10543-023-00967-x},
          issn    = {1572-9125},
          date    = {2023-04-17}
        }

    """

    tableau: ClassVar[RosenbrockTableau] = _tableau

    interpolation_cls: ClassVar[Callable[..., _Rodas6pInterpolation]] = (
        _Rodas6pInterpolation.from_k
    )

    rodas: ClassVar[bool] = True

    def order(self, terms):
        del terms
        return 6


Rodas6p.__init__.__doc__ = """**Arguments:** None"""
